# 50,000円が5,000,000円になる問題 - 完全解決ガイド

## 🚨 問題の詳細

**症状**:
- 管理画面で **50,000円** と設定
- Stripeチェックアウトで **¥5,000,000** と表示される
- **100倍** の価格になってしまう

## 🔍 原因の詳細分析

### データの流れ

```
管理画面入力 → DB保存 → Stripe表示
```

### 正しいデータの流れ

```
入力: 50000（円）
  ↓ × 100
DB: 5000000（銭）
  ↓ Stripe表示
表示: ¥50,000
```

### 現在の間違ったデータの流れ

```
入力: 50000（円）
  ↓ × 100
DB: 5000000（銭） ✓ ここまでは正しい
  ↓ しかし実際には...
DB: 500000000（銭） ✗ 100倍になっている！
  ↓ Stripe表示
表示: ¥5,000,000
```

## 🐛 なぜ100倍になったか

### パターン1: 繰り返し編集

1. **最初の作成**: 50000円 → DB: 5000000銭 ✓
2. **編集画面を開く**: DB 5000000銭 ÷ 100 = 50000円表示 ✓
3. **何も変更せずに保存**: 50000円 × 100 = 5000000銭 ✓
4. **もう一度編集画面を開く**: DB 5000000銭 ÷ 100 = 50000円表示 ✓
5. **また保存**: 50000円 × 100 = 5000000銭 ✓

**しかし、データベースにすでに間違った値が入っている場合:**

1. DB: 500000000銭（間違った値）
2. 編集画面: 500000000 ÷ 100 = 5000000円表示
3. ユーザーが「50000円のはず」と気づいて「50000」に修正
4. 保存: 50000 × 100 = 5000000銭 ✓ 正しい！

### パターン2: 最初から間違った値

何らかの理由で、最初からDBに `500000000` が保存されていた可能性があります。

## ✅ 診断と修正手順

### ステップ1: 問題の診断

```bash
ssh ec2-user@18.178.182.252
cd /home/ec2-user/webapp
git pull origin main

# 詳細診断を実行
./diagnose_and_fix_prices.sh
```

このスクリプトが以下を表示：

1. **全チケットの詳細情報**
   ```
   id | name | db_price_cents | display_price_yen | status_check
   ---+------+----------------+-------------------+--------------
    1 | test |      500000000 |           5000000 | 🔴 異常に高い
   ```

2. **価格分析**
   ```
   total_tickets | min_price_yen | max_price_yen | avg_price_yen
   -------------+---------------+---------------+---------------
              1 |       5000000 |       5000000 |       5000000
   ```

3. **修正が必要なチケット**
   ```
   id | name | current_yen | suggested_correct_yen
   ---+------+-------------+-----------------------
    1 | test |     5000000 |                 50000
   ```

4. **修正用SQLコマンド**（自動生成）

### ステップ2: 修正の実行

#### **方法A: 自動修正スクリプト（最速）**

```bash
cd /home/ec2-user/webapp
./quick_fix_50000_yen.sh
```

プロンプトで `y` を入力すると自動修正されます：

- 5,000,000円（500000000銭） → 50,000円（5000000銭）
- 500,000円（50000000銭） → 5,000円（500000銭）

#### **方法B: 管理画面から修正（最も安全）**

1. ブラウザで管理画面を開く
   ```
   http://18.178.182.252/admin
   ```

2. 「チケット管理」をクリック

3. 該当チケットの「編集」ボタンをクリック

4. **価格フィールドを確認**
   - 現在表示されている値: `5000000`（これは間違い）
   - 正しい値に修正: `50000`

5. 通貨で「JPY (日本円)」が選択されていることを確認

6. 「更新」ボタンをクリック

7. 成功メッセージを確認

#### **方法C: SQLで直接修正**

```bash
psql "postgresql://postgres:Yota19990514@database-2.c9qsy8o0qu9q.ap-northeast-1.rds.amazonaws.com:5432/streaming_platform"
```

```sql
-- 現在の価格を確認
SELECT id, name, price, price/100 as price_yen FROM tickets;

-- 特定のチケットを修正（例: ID=1を50,000円に）
UPDATE tickets SET price = 5000000 WHERE id = 1;

-- 全てのチケットを一括修正（500000000 → 5000000）
UPDATE tickets SET price = 5000000 WHERE price = 500000000;

-- 修正結果を確認
SELECT id, name, price, price/100 as price_yen FROM tickets;

-- 接続を終了
\q
```

### ステップ3: アプリの再起動

```bash
pm2 restart streaming-app
pm2 logs streaming-app --lines 20
```

### ステップ4: 確認

#### A. データベースで確認

```bash
psql "postgresql://postgres:Yota19990514@...streaming_platform" \
  -c "SELECT id, name, price, price/100 as price_yen FROM tickets;"
```

**期待される結果**:
```
 id | name | price   | price_yen
----+------+---------+-----------
  1 | test | 5000000 |     50000
```

#### B. イベント詳細ページで確認

```
http://18.178.182.252/events/[イベントslug]
```

**期待される表示**:
```
test
¥50,000  残り10枚
[購入する]
```

#### C. Stripeチェックアウトで確認

1. 「購入する」ボタンをクリック
2. Stripeチェックアウト画面に遷移
3. **期待される表示**: `¥50,000`
4. **NG表示**: `¥5,000,000`

## 📊 価格変換表

| 円単位 | 銭単位（DB保存値） | SQL修正コマンド |
|-------|-----------------|----------------|
| 3,000円 | 300000 | `UPDATE tickets SET price = 300000 WHERE id = X;` |
| 5,000円 | 500000 | `UPDATE tickets SET price = 500000 WHERE id = X;` |
| 8,000円 | 800000 | `UPDATE tickets SET price = 800000 WHERE id = X;` |
| 10,000円 | 1000000 | `UPDATE tickets SET price = 1000000 WHERE id = X;` |
| 30,000円 | 3000000 | `UPDATE tickets SET price = 3000000 WHERE id = X;` |
| **50,000円** | **5000000** | `UPDATE tickets SET price = 5000000 WHERE id = X;` |
| 100,000円 | 10000000 | `UPDATE tickets SET price = 10000000 WHERE id = X;` |

## 🔍 よくある間違いパターン

### パターン1: 銭単位で入力してしまう

❌ **間違い**: 管理画面で「5000000」と入力
```
入力: 5000000
  ↓ × 100
DB: 500000000（5,000,000円）
```

✅ **正しい**: 管理画面で「50000」と入力（円単位）
```
入力: 50000
  ↓ × 100
DB: 5000000（50,000円）
```

### パターン2: 既存の間違ったデータをそのまま保存

❌ **間違い**:
1. 編集画面を開く → 価格フィールドに「5000000」と表示
2. そのまま保存
3. DB: 500000000になってしまう

✅ **正しい**:
1. 編集画面を開く → 価格フィールドに「5000000」と表示
2. **正しい価格「50000」に修正**
3. 保存
4. DB: 5000000（正しい）

## ⚠️ 予防策

### 管理画面での入力ルール

1. **必ず円単位で入力する**
   - 50,000円のチケット → 「50000」と入力
   - 5,000円のチケット → 「5000」と入力

2. **銭単位では入力しない**
   - ❌「5000000」は入力しない
   - ❌「500000」は入力しない（5,000円の場合を除く）

3. **編集時は表示価格を確認**
   - 表示価格が異常に高い場合（例: 5000000円）
   - 正しい価格に修正してから保存

4. **保存後にイベント詳細ページで確認**
   - 管理画面で保存した後、必ずフロント画面で価格を確認
   - 異常な価格が表示されたら、すぐに編集し直す

## 📋 チェックリスト

- [ ] EC2で最新コードを取得（`git pull origin main`）
- [ ] `./diagnose_and_fix_prices.sh` で診断
- [ ] 異常な価格（price > 10000000銭 = 100,000円以上）を特定
- [ ] 修正実行（自動スクリプト、管理画面、またはSQL）
- [ ] データベースで修正結果を確認
- [ ] `pm2 restart streaming-app` でアプリ再起動
- [ ] イベント詳細ページで「¥50,000」表示を確認
- [ ] Stripeチェックアウトで「¥50,000」表示を確認
- [ ] テスト決済が成功

## 🎯 期待される最終結果

### イベント詳細ページ
```
チケット購入

test
¥50,000  残り10枚
[購入する]
```

### Stripeチェックアウト
```
UMGフェス - test
¥50,000

連絡先情報
メールアドレス: [email]

支払い方法
カード
```

## 📚 関連ファイル

- `diagnose_and_fix_prices.sh` - 詳細診断スクリプト
- `quick_fix_50000_yen.sh` - 緊急修正スクリプト
- `fix_ticket_price.sh` - 基本的な価格確認スクリプト
- `STRIPE_PRICE_100X_FIX.md` - 価格100倍問題の一般ガイド

## 🔗 リポジトリ

**URL**: https://github.com/yotamatsumaru/0222-VOD  
**最新コミット**: `67ac071`

---

## 🚀 今すぐ実行するコマンド

```bash
# EC2に接続
ssh ec2-user@18.178.182.252

# プロジェクトディレクトリに移動
cd /home/ec2-user/webapp

# 最新コードを取得
git pull origin main

# 価格を診断
./diagnose_and_fix_prices.sh

# 自動修正（推奨）
./quick_fix_50000_yen.sh

# アプリ再起動
pm2 restart streaming-app

# ブラウザでテスト
# http://18.178.182.252/events/[イベントslug]
# Stripeチェックアウトで ¥50,000 を確認
```

---

**最終更新**: 2026/02/25  
**ステータス**: 診断・修正スクリプト完成、実行待ち
