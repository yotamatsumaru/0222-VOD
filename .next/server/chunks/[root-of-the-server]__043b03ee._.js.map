{"version":3,"sources":["../../../lib/db.ts","../../../lib/auth.ts"],"sourcesContent":["import { Pool, QueryResult, QueryResultRow } from 'pg';\n\nlet pool: Pool | null = null;\n\nexport function getDatabase(): Pool {\n  if (!pool) {\n    const connectionString = process.env.DATABASE_URL;\n    \n    if (!connectionString) {\n      console.error('DATABASE_URL is not defined in environment variables');\n      throw new Error('DATABASE_URL is not configured');\n    }\n    \n    console.log('Initializing database connection pool...');\n    console.log('Database URL format:', connectionString.replace(/:[^:@]+@/, ':****@')); // Hide password\n    \n    // SSL設定: RDSは自己署名証明書を使用するため rejectUnauthorized: false\n    const sslConfig = {\n      rejectUnauthorized: false // RDSの自己署名証明書を許可\n    };\n    \n    pool = new Pool({\n      connectionString,\n      ssl: sslConfig,\n      max: 20,\n      idleTimeoutMillis: 30000,\n      connectionTimeoutMillis: 5000,\n    });\n\n    pool.on('error', (err) => {\n      console.error('Unexpected error on idle client', err);\n    });\n\n    pool.on('connect', () => {\n      console.log('Database connection established');\n    });\n  }\n  return pool;\n}\n\nexport async function query<T extends QueryResultRow = any>(\n  text: string,\n  params?: any[]\n): Promise<QueryResult<T>> {\n  const db = getDatabase();\n  try {\n    const start = Date.now();\n    const result = await db.query<T>(text, params);\n    const duration = Date.now() - start;\n    console.log('Query executed:', { sql: text.substring(0, 100), duration: `${duration}ms`, rows: result.rowCount });\n    return result;\n  } catch (error: any) {\n    console.error('Database query error:', {\n      sql: text.substring(0, 200),\n      params,\n      error: error.message,\n      code: error.code,\n      detail: error.detail\n    });\n    throw error;\n  }\n}\n\nexport async function getOne<T extends QueryResultRow = any>(\n  text: string,\n  params?: any[]\n): Promise<T | null> {\n  const result = await query<T>(text, params);\n  return result.rows[0] || null;\n}\n\nexport async function getAll<T extends QueryResultRow = any>(\n  text: string,\n  params?: any[]\n): Promise<T[]> {\n  const result = await query<T>(text, params);\n  return result.rows;\n}\n\nexport async function insert<T extends QueryResultRow = any>(\n  text: string,\n  params?: any[]\n): Promise<T> {\n  const result = await query<T>(text, params);\n  return result.rows[0];\n}\n\nexport async function update<T extends QueryResultRow = any>(\n  text: string,\n  params?: any[]\n): Promise<T | null> {\n  const result = await query<T>(text, params);\n  return result.rows[0] || null;\n}\n\nexport async function remove(text: string, params?: any[]): Promise<boolean> {\n  const result = await query(text, params);\n  return result.rowCount !== null && result.rowCount > 0;\n}\n","import jwt from 'jsonwebtoken';\nimport { JWTPayload } from './types';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';\n\nexport function generateAccessToken(payload: Omit<JWTPayload, 'exp'>): string {\n  const expiresIn = 24 * 60 * 60; // 24 hours\n  return jwt.sign(\n    {\n      ...payload,\n      exp: Math.floor(Date.now() / 1000) + expiresIn,\n    },\n    JWT_SECRET\n  );\n}\n\nexport function verifyAccessToken(token: string): JWTPayload | null {\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as JWTPayload;\n    return decoded;\n  } catch (error) {\n    console.error('JWT verification failed:', error);\n    return null;\n  }\n}\n\nexport function decodeAccessToken(token: string): JWTPayload | null {\n  try {\n    const decoded = jwt.decode(token) as JWTPayload;\n    return decoded;\n  } catch (error) {\n    console.error('JWT decode failed:', error);\n    return null;\n  }\n}\n"],"names":[],"mappings":"ypCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,yCAEA,IAAI,EAAoB,KAsCjB,eAAe,EACpB,CAAY,CACZ,CAAc,EAEd,IAAM,EAxCD,AAwCM,SAxCG,EACd,GAAI,CAAC,EAAM,CACT,IAAM,EAAmB,QAAQ,GAAG,CAAC,YAAY,CAEjD,GAAI,CAAC,EAEH,MADA,QAAQ,EADa,GACR,CAAC,wDACR,AAAI,MAAM,kCAGlB,QAAQ,GAAG,CAAC,4CACZ,QAAQ,GAAG,CAAC,uBAAwB,EAAiB,OAAO,CAAC,WAAY,WAezE,CAfqF,AAOrF,EAAO,IAAI,EAAA,IAAI,CAAC,CACd,EARmG,iBASnG,IANgB,CAChB,AAKK,oBALe,CACtB,EAKE,GAN0B,CAMrB,GACL,aAP2C,KAOxB,IACnB,wBAAyB,GAC3B,EAAA,EAEK,EAAE,CAAC,QAAS,AAAC,IAChB,QAAQ,KAAK,CAAC,kCAAmC,EACnD,GAEA,EAAK,EAAE,CAAC,UAAW,KACjB,QAAQ,GAAG,CAAC,kCACd,EACF,CACA,OAAO,CACT,IAOE,GAAI,CACF,IAAM,EAAQ,KAAK,GAAG,GAChB,EAAS,MAAM,EAAG,KAAK,CAAI,EAAM,GACjC,EAAW,KAAK,GAAG,GAAK,EAE9B,OADA,QAAQ,GAAG,CAAC,kBAAmB,CAAE,IAAK,EAAK,SAAS,CAAC,EAAG,KAAM,SAAU,CAAA,EAAG,EAAS,EAAE,CAAC,CAAE,KAAM,EAAO,QAAQ,AAAC,GACxG,CACT,CAAE,MAAO,EAAY,CAQnB,MAPA,QAAQ,KAAK,CAAC,wBAAyB,CACrC,IAAK,EAAK,SAAS,CAAC,EAAG,YACvB,EACA,MAAO,EAAM,OAAO,CACpB,KAAM,EAAM,IAAI,CAChB,OAAQ,EAAM,MAAM,AACtB,GACM,CACR,CACF,CAEO,eAAe,EACpB,CAAY,CACZ,CAAc,EAGd,MAAO,CADQ,MAAM,EAAS,EAAM,EAAA,EACtB,IAAI,CAAC,EAAE,EAAI,IAC3B,CAEO,eAAe,EACpB,CAAY,CACZ,CAAc,EAGd,MAAO,CADQ,MAAM,EAAS,EAAM,EAAA,EACtB,IAAI,AACpB,CAEO,eAAe,EACpB,CAAY,CACZ,CAAc,EAGd,MAAO,CADQ,MAAM,EAAS,EAAM,EAAA,EACtB,IAAI,CAAC,EAAE,AACvB,CAEO,eAAe,EACpB,CAAY,CACZ,CAAc,EAGd,MAAO,CADQ,MAAM,EAAS,EAAM,EAAA,EACtB,IAAI,CAAC,EAAE,EAAI,IAC3B,CAEO,eAAe,EAAO,CAAY,CAAE,CAAc,EACvD,IAAM,EAAS,MAAM,EAAM,EAAM,GACjC,OAA2B,OAApB,EAAO,QAAQ,EAAa,EAAO,QAAQ,CAAG,CACvD,2UClGA,IAAA,EAAA,EAAA,CAAA,CAAA,OAGA,IAAM,EAAa,QAAQ,GAAG,CAAC,UAAU,EAAI,kBAEtC,SAAS,EAAoB,CAAgC,EAElE,OAAO,EAAA,OAAG,CAAC,IAAI,CACb,CACE,GAAG,CAAO,CACV,IAAK,KAAK,KAAK,CAAC,KAAK,GAAG,GAAK,KAJf,GAIuB,EACvC,AALqB,EAMrB,EAEJ,CAR8B,AAUvB,IAV2B,KAUlB,EAAkB,CAAa,EAC7C,CAX2C,EAWvC,CAEF,OADgB,AACT,EADS,OAAG,CAAC,MAAM,CAAC,EAAO,EAEpC,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,IACT,CACF"}