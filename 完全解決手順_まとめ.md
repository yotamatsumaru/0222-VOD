# 管理画面ログインエラー 完全解決手順

## 🎯 現在の状況

EC2上で管理画面にログインすると「**Application error: a client-side exception has occurred**」が発生する問題が報告されました。

## ❌ エラーの原因

```
Uncaught TypeError: Cannot read properties of undefined (reading 'toLocaleString')
```

このエラーは、統計データが `null` または `undefined` の状態で `.toLocaleString()` メソッドを呼び出したために発生しています。

### 根本原因:

1. **古いビルドキャッシュ**: EC2の `.next` フォルダに古いJavaScriptファイルが残っている
2. **コード未適用**: 最新の修正（null安全性）が反映されていない
3. **ブラウザキャッシュ**: ブラウザが古いJavaScriptを読み込んでいる

## ✅ 実施した修正（GitHubに反映済み）

### 修正1: `app/admin/page.tsx` のnull安全性向上（コミット 81c1e22）

**変更前**（エラーが発生）:
```tsx
<div className="text-3xl font-bold text-white">
  ¥{stats.totalSales.toLocaleString()}
</div>
```

**変更後**（null安全）:
```tsx
<div className="text-3xl font-bold text-white">
  ¥{(stats.totalSales || 0).toLocaleString()}
</div>
```

### 修正2: エラー時のデフォルト値設定

```tsx
const fetchStats = async () => {
  try {
    // ... API呼び出し ...
  } catch (err) {
    console.error('Failed to fetch stats:', err);
    // エラー時もデフォルト値を設定して画面が壊れないように
    setStats({
      totalSales: 0,
      totalPurchases: 0,
      totalEvents: 0,
      totalArtists: 0,
    });
  }
};
```

### 修正3: マイグレーションスクリプトの改善（コミット b8b7714）

`scripts/migrate.js` に dotenv を追加して `.env.local` を読み込むように修正:

```javascript
require('dotenv').config({ path: '.env.local' });
const { Pool } = require('pg');

const DATABASE_URL = process.env.DATABASE_URL;

if (!DATABASE_URL) {
  console.error('❌ Error: DATABASE_URL is not set in .env.local');
  process.exit(1);
}
```

### 修正4: RDS SSL接続の改善（コミット f36af70）

`lib/db.ts` でRDS証明書エラーを解決:

```typescript
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000,
  ssl: process.env.DATABASE_URL?.includes('rds.amazonaws.com')
    ? { rejectUnauthorized: false }  // RDS用のSSL設定
    : false,
});
```

## 🚀 EC2での完全解決手順

### ⚠️ 重要な注意事項

- **必ずシークレットモードで確認してください**
- **ビルドキャッシュを完全削除する必要があります**
- **最新コード（コミット faf95ef）を取得してください**

### 📋 手順（EC2で実行）

#### ステップ1: 現在のプロセスを停止

```bash
cd /home/ec2-user/webapp
pm2 stop webapp
pm2 delete webapp
pm2 kill
```

#### ステップ2: プロジェクトを完全削除

```bash
cd /home/ec2-user
rm -rf webapp
```

#### ステップ3: 最新コードをクローン

```bash
git clone https://github.com/yotamatsumaru/0222-VOD.git webapp
cd webapp
git log --oneline -1
```

**期待される出力**:
```
faf95ef docs: EC2完全クリーンデプロイガイドを追加、READMEに管理画面エラー対応を記載
```

または:

```
81c1e22 fix: 管理画面ページのnull安全性を修正 - toLocaleStringエラーを完全解決
```

#### ステップ4: 依存関係をインストール

```bash
npm install
```

#### ステップ5: `.env.local` を作成

```bash
cat > .env.local << 'EOF'
# Database (RDS接続情報を入力)
DATABASE_URL=postgresql://postgres:<YOUR_RDS_PASSWORD>@database-2.c9qsy8o0qu9q.ap-northeast-1.rds.amazonaws.com:5432/streaming_platform

# Stripe
STRIPE_SECRET_KEY=sk_test_your_stripe_secret_key_here
STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_publishable_key_here
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_publishable_key_here

# JWT Secret（32文字以上のランダム文字列）
JWT_SECRET=your_jwt_secret_minimum_32_characters_long

# Admin Credentials
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your_secure_admin_password

# App URL
NEXT_PUBLIC_APP_URL=http://18.178.182.252
EOF
```

⚠️ **必ず以下を置き換えてください**:
- `<YOUR_RDS_PASSWORD>`: 実際のRDSパスワード
- `your_secure_admin_password`: 管理画面用の安全なパスワード
- `your_jwt_secret_minimum_32_characters_long`: 32文字以上のランダム文字列

#### ステップ6: データベースを確認

```bash
# RDS接続テスト
psql -h database-2.c9qsy8o0qu9q.ap-northeast-1.rds.amazonaws.com \
     -U postgres \
     -d streaming_platform \
     -c "\dt"
```

**テーブルが存在しない場合**:

```bash
# データベース作成
psql -h database-2.c9qsy8o0qu9q.ap-northeast-1.rds.amazonaws.com \
     -U postgres \
     -d postgres \
     -c "CREATE DATABASE streaming_platform;"

# マイグレーション実行
npm run db:migrate

# サンプルデータ投入（オプション）
npm run db:seed
```

#### ステップ7: プロダクションビルド

```bash
npm run build
```

**期待される出力**:
```
   Generating static pages (0/6)  [    ]
✓ Generating static pages (6/6)
✓ Finalizing page optimization
✓ Collecting build traces

Route (app)                              Size     First Load JS
┌ ○ /                                    10.2 kB        150 kB
├ ○ /admin                               15.3 kB        155 kB
├ ○ /api/health                          0 B              0 B
└ ○ /events/[slug]                       8.5 kB         148 kB

✓ Compiled successfully
```

#### ステップ8: PM2で起動

```bash
# アプリを起動
pm2 start "npx next start -H 0.0.0.0 -p 3000" --name webapp

# プロセスリストを保存
pm2 save

# 自動起動設定
pm2 startup
```

#### ステップ9: 動作確認

```bash
# PM2ステータス確認
pm2 list

# ログ確認
pm2 logs webapp --lines 30

# ヘルスチェック
curl http://localhost:3000/api/health
```

**期待されるヘルスチェック結果**:
```json
{
  "status": "ok",
  "database": "connected",
  "timestamp": "2026-02-22T20:30:00.000Z",
  "environment": "production"
}
```

## 🌐 ブラウザでの確認

### 1. シークレットモードで開く

- **Chrome**: Ctrl + Shift + N
- **Firefox**: Ctrl + Shift + P
- **Safari**: Cmd + Shift + N

### 2. 管理画面にアクセス

```
http://18.178.182.252/admin
```

### 3. ログイン

- **ユーザー名**: `admin`
- **パスワード**: `.env.local` で設定した `ADMIN_PASSWORD`

### 4. 確認ポイント

✅ **成功の確認**:
- ログイン後、エラーなくダッシュボードが表示される
- 統計情報が表示される（0または実際の数値）
- ブラウザコンソール（F12）にエラーが表示されない

❌ **まだエラーが出る場合**:
1. ブラウザのキャッシュを完全削除
2. ハードリロード（Ctrl + Shift + R）
3. シークレットモード以外のブラウザで試す

## 🧪 動作テスト

### テスト1: アーティスト追加

1. 「アーティスト管理」タブをクリック
2. 「新規追加」ボタンをクリック
3. 以下を入力:
   - 名前: `テストアーティスト`
   - プロフィール: `これはテストです`
4. 「作成」ボタンをクリック
5. ✅ リストに追加されることを確認

### テスト2: イベント追加

1. 「イベント管理」タブをクリック
2. 「新規追加」ボタンをクリック
3. 以下を入力:
   - タイトル: `テストイベント`
   - アーティスト: 作成したアーティストを選択
   - 開始日時: 未来の日時を選択
4. 「作成」ボタンをクリック
5. ✅ リストに追加されることを確認

### テスト3: チケット追加

1. 「チケット管理」タブをクリック
2. 「新規追加」ボタンをクリック
3. 以下を入力:
   - イベント: 作成したイベントを選択
   - チケット名: `一般チケット`
   - 価格: `3000`
   - 在庫数: `100`
4. 「作成」ボタンをクリック
5. ✅ リストに追加されることを確認

## 🔍 トラブルシューティング

### エラー1: まだ「Application error」が表示される

**原因**: ブラウザキャッシュが残っている

**解決方法**:
1. Ctrl + Shift + Delete でキャッシュ削除
2. 完全に別のブラウザで試す
3. EC2のビルドが最新か確認: `git log --oneline -1`

### エラー2: `database "streaming_platform" does not exist`

**原因**: データベースが作成されていない

**解決方法**:
```bash
psql -h database-2.c9qsy8o0qu9q.ap-northeast-1.rds.amazonaws.com \
     -U postgres \
     -d postgres \
     -c "CREATE DATABASE streaming_platform;"
npm run db:migrate
pm2 restart webapp
```

### エラー3: `relation "artists" does not exist`

**原因**: マイグレーションが実行されていない

**解決方法**:
```bash
npm run db:migrate
pm2 restart webapp
```

### エラー4: `self-signed certificate`

**原因**: DATABASE_URLに `?sslmode=require` が含まれている

**解決方法**:
`.env.local` の `DATABASE_URL` から `?sslmode=require` を削除して:
```bash
pm2 restart webapp
```

### エラー5: PM2ログにエラーが続く

**解決方法**:
```bash
# ログを確認
pm2 logs webapp --lines 100

# 完全再起動
pm2 stop webapp
pm2 delete webapp
rm -rf .next
npm run build
pm2 start "npx next start -H 0.0.0.0 -p 3000" --name webapp
pm2 save
```

## 📚 関連ドキュメント

すべてGitHubリポジトリに含まれています:

- **EC2_CLEAN_DEPLOYMENT.md** - この手順の詳細版
- **RDS_SETUP.md** - RDS設定ガイド
- **QUICK_START_RDS.md** - EC2+RDSクイックスタート
- **DATABASE_SETUP.md** - ローカルPostgreSQL設定
- **TROUBLESHOOTING_ADMIN.md** - 管理画面エラー対応
- **AWS_DEPLOYMENT.md** - AWS EC2デプロイ全般

## 🎯 最新コミット情報

### リポジトリ
https://github.com/yotamatsumaru/0222-VOD

### 最新5コミット

```
faf95ef - docs: EC2完全クリーンデプロイガイドを追加、READMEに管理画面エラー対応を記載
81c1e22 - fix: 管理画面ページのnull安全性を修正 - toLocaleStringエラーを完全解決
b8b7714 - fix: マイグレーションスクリプトでdotenvを使用して.env.localを読み込み
f36af70 - fix: RDS SSL証明書エラー対応、接続設定を改善
92ce2aa - fix: ダッシュボードのnull/undefined安全性を改善、エラー時もデフォルト値を表示
```

## ✅ 完全解決の確認

すべてが正常に動作している場合:

1. ✅ PM2で webapp が `online` 状態
2. ✅ `curl http://localhost:3000/api/health` が `"database":"connected"` を返す
3. ✅ ブラウザで `http://18.178.182.252/admin` にアクセスできる
4. ✅ ログイン後、ダッシュボードが表示される
5. ✅ ブラウザコンソール（F12）にエラーがない
6. ✅ アーティスト・イベント・チケットの追加が成功する
7. ✅ PM2ログにエラーがない

## 💡 今後の推奨事項

1. **定期的な更新**: `git pull origin main` で最新コードを取得
2. **ログ監視**: `pm2 logs webapp` で定期的にログを確認
3. **セキュリティ**: `.env.local` のパーミッションを `chmod 600` に設定
4. **バックアップ**: RDSの自動バックアップを有効化
5. **監視**: CloudWatch でEC2とRDSを監視

---

**作成日**: 2026-02-22  
**対象**: AWS EC2 + RDS PostgreSQL 環境  
**最終更新コミット**: faf95ef
